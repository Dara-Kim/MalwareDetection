import numpy as np
import pandas as pd
import tensorflow as tf
import tensorflow_decision_forests as tfdf

with open('1848_api.txt') as f:
    api_1848 = f.read().split('\n')
with open('530_perm.txt') as f:
    perm_530 = f.read().split('\n')

api_dict=dict((a,i) for i, a in enumerate(api_1848))
perm_dict=dict((p,i) for i, p in enumerate(perm_530))

api_list = [0]*1848
with open('./api_extracted.txt', 'r') as f:
    apk=f.read().split('\n')[1:-1]
for api in apk:
    if api in api_1848:
        api_list[api_dict[api]]=1

api = pd.DataFrame([api_list])

perm_list = [0]*530
with open(f'./perm_extracted.txt', 'r') as f:
    apk=f.read().split('\n')[1:-1]

for line in apk:
    if "'" in line:
        perm = line.split("'")[1]
    elif 'name=' in line:
        perm = line.split("name=")[1]
    else:
        perm = line.split()[1]
    if perm in perm_530:
        perm_list[perm_dict[perm]]=1

perm = pd.DataFrame([perm_list])

tmp = pd.concat([api, perm], axis=1)
tmp.columns = [str(i) for i in range(2378)]
tmp = pd.DataFrame(tmp.loc[0].apply(str)).T
tmp = tfdf.keras.pd_dataframe_to_tf_dataset(tmp)
saved_model = tf.keras.models.load_model('model')
y_predict = saved_model.predict(tmp)
print(y_predict[0][0])